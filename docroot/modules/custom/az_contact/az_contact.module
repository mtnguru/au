<?php
/**
 * @file
 * Contains az_contact.module.
 */

use Drupal\az_content\AzContentQuery;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Markup;
use Drupal\Core\Url;
use Drupal\media\Entity\Media;
use Drupal\node\Entity\Node;
use Drupal\node\NodeInterface;

/**
 * Implements hook_mail().
 */
function az_contact_mail($key, &$message, $params) {
  switch ($key) {
    case 'contact_key':
//    $message['from'] = \Drupal::config('system.site')->get('mail');
      $message['from'] = 'Investor Information <investment@aureon.ca>';
      $message['reply-to'] = 'Investor Relations <ir@aureon.ca>';
      $message['subject'] = $params['subject'];
      $message['body'][] = Markup::create($params['message']);
      $message['headers']['Content-Type'] = SWIFTMAILER_FORMAT_HTML;

      $file1 = new stdClass();
      $file1->uri = 'sites/default/files/Aureon_logo.png';
      $file1->filename = 'Aureon_logo.png';
      $file1->filemime = 'image/png';
//    $message['params']['files'][] = $file1;
      $message['files'][] = $file1;

      /*
      $file2 = new stdClass();
      $file2->uri = 'sites/default/files/document/2020-03/document/Aureon Energy - PPM - The SAFIRE Project.pdf';
      $file2->filename = 'Aureon Energy - PPM - The SAFIRE Project.pdf';
      $file2->filemime = 'application/pdf';
      $message['params']['files'][] = $file2;
      $message['files'][] = $file2;
      */

      /*
      $file3 = new stdClass();
      $file3->uri = 'sites/default/files/document/2020-03/document/20200130-1 SAFIRE Project Gantt Chart 4.pdf';
      $file3->filename = '20200130-1 SAFIRE Project Gantt Chart 4.pdf';
      $file3->filemime = 'application/pdf';
      $message['params']['files'][] = $file3;
      $message['files'][] = $file3;
      */

      if (!empty($params['attachments'])) {
        foreach($params['attachments'] as $attachment) {
          $mid = $attachment['target_id']; // get file fid;
          $media = Media::load($mid);
          if (isset($media->field_document)) {
            $file = \Drupal\file\Entity\File::load($media->field_document->target_id);

            $f = new stdClass();
            $f->uri = $file->getFileUri();
            $f->filename = $file->getFilename();
            $f->filemime = $file->getMimeType();

            $message['params']['files'][] = $f;
            $message['files'][] = $f;
          }
        }
      }
      break;
  }
}

function az_contact_send_email($subject, $message, $attachments, $email) {
  $mailManager = \Drupal::service('plugin.manager.mail');
  $params['subject'] = $subject;
  $params['message'] = $message;
  $params['attachments'] = $attachments;
  $langcode = \Drupal::currentUser()->getPreferredLangcode();
  $send = true;
  $result = $mailManager->mail('az_contact', 'contact_key', $email, $langcode, $params, NULL, $send);
}

function az_contact_emailit ($node) {
  if ($node->field_send_email->value) {
    $message = $node->body->value;
    $subject = $node->label();
    $attachments = [];
    if (!$node->field_media_attachment->isEmpty()) {
      $attachments = $node->get('field_media_attachment')->getValue();
    }

    // Create array of selected Interest Ids
    $interestIds = [];
    foreach ($node->get('field_interest') as $item) {
      $interestIds[] = $item->target_id;
    }

    if (count($interestIds)) {
      // Create the mailing list
      $set = [
        'types' => 'contact',
        'interest' => $interestIds,
      ];
      $res = AzContentQuery::nodeQuery($set);

      if (count($res['results'])) {
        foreach ($res['results'] as $row) {
          $contact = Node::load($row->nid);
          az_contact_send_email($subject, $message, $attachments, $contact->field_email->value);
        }
      }
    }
  }
}

function az_contact_node_insert(Node $node) {
  if ($node->bundle() == 'email') {
    az_contact_emailit($node);
  }
}

function az_contact_node_update(Node $node) {
  if ($node->bundle() == 'email') {
    az_contact_emailit($node);
  }
}

function az_contact_form_alter(&$form, &$form_state, $form_id) {
  return;
}

function az_contact_form_node_email_form_alter(&$form, &$form_state, $form_id) {
  foreach (array_keys($form['actions']) as $action) {
    if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
      $form['actions'][$action]['#submit'][] = 'ac_contact_form_node_email_submit';
    }
  }
  return;
}

function ac_contact_form_node_email_submit(&$form, FormStateInterface &$form_state) {

  // if send email is enabled then build a list of emails and send the file
  return;
}



